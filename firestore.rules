rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is admin or agent
    function isAdminOrAgent() {
      return isAuthenticated() && 
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent');
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user documents (for public profiles)
      // This allows viewing agent profiles on listing pages
      allow read: if true;
      
      // Users can only create/update their own document
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      
      // Only allow role changes by existing admins (prevent self-promotion)
      allow update: if isAdmin();
      
      // No deletion of user documents
      allow delete: if false;
    }
    
    // Listings collection
    match /listings/{listingId} {
      // Anyone can read listings (public access for website)
      // The service layer filters to only show active listings
      allow read: if true;
      
      // Admins and agents can create listings
      allow create: if isAdminOrAgent() &&
                      request.resource.data.createdBy == request.auth.uid &&
                      request.resource.data.title is string &&
                      request.resource.data.description is string &&
                      request.resource.data.price is number &&
                      request.resource.data.price > 0 &&
                      request.resource.data.location is map &&
                      request.resource.data.status in ['active', 'sold', 'pending', 'rented', 'pledged'];
      
      // Admin and agent who created the listing can update it
      allow update: if isAdminOrAgent() &&
                      resource.data.createdBy == request.auth.uid;
      
      // Admin and agent who created the listing can delete it (or mark for deletion)
      allow delete: if isAdminOrAgent() &&
                      resource.data.createdBy == request.auth.uid;
    }
    
    // Projects collection
    match /projects/{projectId} {
      // Anyone can read projects (public access for website)
      allow read: if true;
      
      // Admins and agents can create projects
      allow create: if isAdminOrAgent() &&
                      request.resource.data.createdBy == request.auth.uid &&
                      request.resource.data.name is string &&
                      request.resource.data.description is string &&
                      request.resource.data.developer is string &&
                      request.resource.data.developedBy is string &&
                      request.resource.data.location is map &&
                      request.resource.data.status in ['upcoming', 'under-construction', 'completed', 'sold-out'];
      
      // Admin and agent who created the project can update it
      allow update: if isAdminOrAgent() &&
                      resource.data.createdBy == request.auth.uid;
      
      // Admin and agent who created the project can delete it
      allow delete: if isAdminOrAgent() &&
                      resource.data.createdBy == request.auth.uid;
    }
    
    // Deny all other database access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
